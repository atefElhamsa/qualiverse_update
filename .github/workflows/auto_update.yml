name: Auto Update Build

on:
  push:
    branches:
      - dev

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write   # ðŸ”¥ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Zip Release
        shell: pwsh
        run: |
          $releasePath = "build\windows\x64\runner\Release"
          if (-Not (Test-Path $releasePath)) {
            Write-Error "Release folder not found: $releasePath"
            exit 1
          }

          Compress-Archive `
            -Path "$releasePath\*" `
            -DestinationPath "build\qualiverse_release.zip" `
            -Force

      - name: Clone public updater repo
        shell: pwsh
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/atefElhamsa/qualiverse_updater.git updater
          cd updater

          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Update version.json
        shell: pwsh
        run: |
          cd updater

          $json = Get-Content version.json | ConvertFrom-Json
          $parts = $json.version -split "\."
          $parts[2] = ([int]$parts[2] + 1)
          $json.version = ($parts -join ".")

          $json.url = "https://github.com/atefElhamsa/qualiverse_updater/releases/download/v$($json.version)/qualiverse_release.zip"

          $json | ConvertTo-Json -Depth 10 | Set-Content version.json

          git add version.json
          git commit -m "Update version to $($json.version)"
          git push

          echo "VERSION=$($json.version)" >> $env:GITHUB_ENV

      - name: Create Git tag
        shell: pwsh
        run: |
          cd updater
          git tag v${{ env.VERSION }}
          git push origin v${{ env.VERSION }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          files: build/qualiverse_release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
